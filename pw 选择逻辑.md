### **编写高质量 Playwright 脚本：给 AI 编码助手的核心指令与最佳实践**

你好，AI 助手。当我请求你编写 Playwright 自动化脚本时，请严格遵守以下核心原则和最佳实践。我们的首要目标是脚本的**长期稳定性**和**可维护性**，而不是临时的、脆弱的解决方案。

#### **黄金原则：优先使用面向用户的“意图”定位器**

请**绝对避免**使用依赖于页面内部 DOM 结构或动态 CSS 类名的定位器（如 `div:nth-child(3)` 或 `class="css-1a2b3c"`）。脚本必须模拟一个真实用户，只关心那些用户能看到、能理解的元素。

**定位器优先级清单（请严格按此顺序选择）：**

1.  🥇 **`getByRole()`**: **第一选择**。通过元素的无障碍角色（'button', 'link', 'textbox', 'checkbox' 等）和可见名称来定位。这是最稳定、最符合用户意图的方式。

    - **示例**: `page.getByRole('button', { name: '确认提交' })`

2.  🥈 **`getByLabel()` / `getByPlaceholder()` / `getByText()`**: 当元素没有明确角色或需要通过旁边的文字定位时使用。

    - **`getByLabel()`**: 用于定位由`<label>`标签关联的表单元素。
    - **`getByPlaceholder()`**: 用于定位带有`placeholder`提示文本的输入框。
    - **`getByText()`**: 用于定位包含特定文本的任何元素。

3.  🥉 **`getByTestId()`**: 如果前端代码在关键元素上预置了`data-testid`属性，请优先使用它。这是专门为自动化设计的、与实现解耦的钩子。

4.  🚫 **最后手段**: 仅在上述所有方法都不可行时，才考虑使用 CSS 选择器或 XPath。并且必须选择最简洁、最不依赖层级结构的写法（例如，使用属性选择器 `[aria-label="关闭"]` 而不是复杂的路径）。

#### **原则二：针对特定元素的“意图”指令**

对于常见的 UI 组件，请使用 Playwright 封装好的高级“意图”指令，而不是手动模拟每一个点击步骤。

- **对于原生下拉框 (`<select>`)**:

  - **要用**: `locator.selectOption({ label: '选项文本' })`。
  - **不要用**: 手动点击`<select>`，再点击`<option>`。

- **对于文件上传 (`<input type="file">`)**:

  - **要用**: `locator.setInputFiles('文件路径')`。
  - **不要用**: 尝试操作弹出的操作系统文件选择窗口。该指令能直接、稳定地完成文件设置，即使`<input>`元素是隐藏的。

- **对于复选/单选框 (`<input type="checkbox/radio">`)**:
  - **要用**: `locator.check()`。
  - **不要用**: `.click()`。`.check()`是幂等的（已勾选则不操作），更安全。

#### **原则三：模拟真实、完整的用户交互**

脚本的每一步都应尽可能模拟真实用户的操作流。

- **输入与提交**: 在输入框中填写内容后，如果功能支持，可以通过模拟按下回车键 (`locator.press('Enter')`) 来提交，这比定位提交按钮更简洁。
- **悬停操作**: 对于需要鼠标`hover`才出现的菜单，请使用 `locator.hover()` 来触发，然后再点击出现的菜单项。
- **等待机制**: **永远不要使用固定的时间等待（如`sleep(5000)`）**。请完全信赖 Playwright 的自动等待机制。如果需要等待特定条件，请使用网络等待（`page.waitForResponse`）或断言等待（`expect(locator).toBeVisible()`）。

#### **信息来源：如何为 AI 提供最高质量的“原料”**

为了让你（AI 助手）能更好地遵守以上规则，我会通过以下方式为你提供页面信息：

1.  **首选 - Playwright Codegen**: 我会使用 `npx playwright codegen` 录制我的操作，并将生成的**JavaScript/Python 代码**提供给你。这其中包含了 Playwright 推荐的最佳定位器。
2.  **备选 - 开发者工具**: 当需要分析特定复杂组件时，我会右键“检查”元素，并查看**“无障碍(Accessibility)”面板**来确定其**Role**和**Name**，或者复制其**outerHTML**提供给你。

---

**总结**: 请将自己定位为一个**模拟真实用户的智能机器人**，而不是一个 DOM 解析器。你的代码应该清晰地反映**用户的操作意图**，这样的脚本才能在面对不断变化的前端代码时，依然保持健壮和稳定。
